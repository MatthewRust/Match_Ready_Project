{% extends 'Match_Ready/base.html' %}
{% load static %}

{% block title_block %}
    Fixtures
{% endblock %}

{% block body_block %}
    <h1>Fixtures - All Upcoming Matches</h1>

    {% if upcoming_matches %}
        <ul class="match-list">
        {% for match in upcoming_matches %}
            <li>
                {{ match }} {# Display basic match info (e.g., Team A vs Team B on Date) #}

                {# AJAX Attend Button - Only show if user is logged in #}
                {% if user.is_authenticated %}
                    {# Check if user is already attending this specific match using the context variable #}
                    {% if match.id in user_attending_match_ids %}
                        {# User is attending: Show disabled button #}
                        <button class="button attend-button" data-match-id="{{ match.id }}" disabled>
                            Attending
                        </button>
                    {% else %}
                        {# User is NOT attending: Show active button #}
                        <button class="button attend-button" data-match-id="{{ match.id }}">
                            Attend Match
                        </button>
                    {% endif %}
                    {# Display current attendee count #}
                    <span class="attendee-count" data-match-id="{{ match.id }}">{{ match.attendees }}</span> attendees
                {% else %}
                     {# User not logged in: Show login link #}
                     - <a href="{% url 'Match_Ready:login' %}?next={{ request.path }}">Login to attend</a>
                {% endif %}
                {# Span to show AJAX status messages (success/error) #}
                <span class="attend-status" data-match-id="{{ match.id }}"></span>
            </li>
        {% endfor %}
        </ul>
    {% else %}
        <h2>There are no upcoming matches scheduled at the moment.</h2>
        {# Optional: Add link for coaches to create matches #}
        {# This would require passing an 'is_coach' flag from the view if desired #}
        {% comment %}
        {% if is_coach %}
             <p>As a coach, you can <a href="{% url 'Match_Ready:add_match' %}">add a new match</a>.</p>
        {% endif %}
        {% endcomment %}
    {% endif %}
{% endblock %}

{# Include the AJAX script block if it's not already globally available in base.html #}
{% block scripts_extra %}
<script>
    // Simple function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    $(document).ready(function() {
        // Use event delegation on the list for potentially dynamic content (good practice)
        $('.match-list').on('click', '.attend-button', function() {
            const button = $(this);
            const matchId = button.data('match-id');
            // Find status/count spans relative to the button's list item parent
            const listItem = button.closest('li'); // Find the parent <li>
            const statusSpan = listItem.find(`.attend-status[data-match-id=${matchId}]`);
            const countSpan = listItem.find(`.attendee-count[data-match-id=${matchId}]`);

            // Prevent multiple clicks while processing
            if (button.prop('disabled')) {
                return; // Already disabled (either processing or already attending)
            }
            button.prop('disabled', true); // Disable immediately
            statusSpan.text('Processing...').css('color', 'grey').show(); // Provide feedback

            $.ajax({
                url: "{% url 'Match_Ready:attend_match_ajax' %}", // The URL for our AJAX view
                type: "POST",
                data: {
                    'match_id': matchId,
                    'csrfmiddlewaretoken': csrftoken // Include CSRF token
                },
                dataType: 'json', // Expect JSON response
                success: function(data) {
                    if (data.status === 'success') {
                        statusSpan.text(data.message).css('color', 'green').fadeOut(4000); // Fade out success message after 4 seconds
                        button.text('Attending'); // Keep button disabled and text updated
                        countSpan.text(data.new_count); // Update count
                    } else {
                        // Handle specific errors reported by the server (e.g., already attending)
                        statusSpan.text('Error: ' + data.message).css('color', 'red');
                        if (data.already_attending) {
                             button.text('Attending'); // Ensure text is correct, keep disabled
                        } else {
                             button.prop('disabled', false); // Re-enable button on other logical errors
                        }
                    }
                },
                error: function(xhr, errmsg, err) {
                    console.error("AJAX Error:", xhr.status, xhr.responseText); // Log detailed error to console
                    let errorMsg = 'An error occurred. Please try again.';
                    if (xhr.status === 403) { // Forbidden (likely not logged in)
                         errorMsg = 'Please login to attend.';
                         // Optional: Redirect to login
                         // window.location.href = "{% url 'Match_Ready:login' %}?next=" + window.location.pathname;
                    } else if (xhr.status === 404) { // Not Found
                        errorMsg = 'Match not found.';
                    } else if (xhr.status === 400 && xhr.responseJSON && xhr.responseJSON.message) { // Bad Request with JSON message
                        errorMsg = 'Error: ' + xhr.responseJSON.message;
                         if (xhr.responseJSON.already_attending) {
                             button.text('Attending'); // Keep disabled
                         }
                    } else if (xhr.status === 405) { // Method Not Allowed
                         errorMsg = 'Invalid request method.';
                    } else if (xhr.status >= 500) { // Server error
                         errorMsg = 'Server error. Please try again later.';
                    }

                    statusSpan.text(errorMsg).css('color', 'red');

                    // Only re-enable the button if the error wasn't "already attending"
                    if (!button.text().includes('Attending')) {
                        button.prop('disabled', false);
                    }
                }
            });
        });
    });
</script>
{% endblock %}